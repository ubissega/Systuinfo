<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Systuinfo - init</title>

 	


    <!-- Bootstrap core CSS -->
<link href="css/bootstrap.min.css" rel="stylesheet">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
          nav,footer{
          background: #00990090;
          color: white;
        }
      }
      body {
        /* Define um gradiente linear como plano de fundo */
   		background: url(./img/bg/login.png) no-repeat fixed;
        background-size: cover;
        
      }
      nav,footer{
          background: #00990090;
        color: white;
      }
      .titular_page{
        border: solid 2px #55e7ff;
        background: #55e7ff90;
        color: white; !important;
      }
      .bg-padrao{
        background: #55e7ff;
      }
      .btn{
        background: #55e7ff90;

      }
      .btn:hover{
        background: #55e7ff;

      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="css/offcanvas.css" rel="stylesheet">
  </head>
  <body class="">

  <script>
   history.pushState(null, null, window.location.href);
window.onpopstate = function() {
    history.pushState(null, null, window.location.href);
};

  </script>


	 <nav class=" navbar bg-body-tertiary fixed-top" >
	  <div class="container">
	    <h1 class="text-uppercase navbar-brand">systuinfo</h1>
	    <button class="text-uppercase btn text-white border" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
	       Menu
	    </button>
	    <div class="offcanvas offcanvas-end bg-padrao" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
	      <div class="offcanvas-header">
	        <h5 class="" id="offcanvasNavbarLabel">Opcoes do menu</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	      </div>
	      <div class="offcanvas-body">
	        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">

				<li><a class="dropdown-item" href="index.html">Pagina inicial</a></li>
				<li><a class="dropdown-item" href="cadastro.html">Inscrição</a></li>
				<li><hr class="dropdown-divider"></li>
				<li><a class="dropdown-item" href="#">Manual de uso</a></li>        
	    </div>
	  </div>
	</nav>

	<main class="container mb-5">
		<div class="row titular_page">	      
	      <div class=" d-flex align-items-center p-3 m-2 text-uppercase rounded shadow-sm">
	        <img class="me-3" src="./img/perfil/user.png" alt="" width="48" height="48">
	        <div class="lh-1">
	          <h1 class="h6 mb-0 lh-1">Iniciar sessao</h1>
	        </div>
	      </div>
	    </div>
	    <div class="row"> 
			<p class="col-md-12 bg-padrao">
			Por favor, lembre-se de cuidar das suas credenciais de forma segura e confidencial.
			</p>   
			<p class="col"></p>
			<div class="col-md-4 bg-body shadow-sm">
        		<div class="m-2">
					<h6 class="border-bottom pb-2 mb-0">Credencias</h6>
					<p id="msg_login"></p>
					<div class="d-flex text-muted pb-1">   
					  	<p class=" small w-100">
						    <strong class="d-block text-gray-dark">Email</strong>          
						    <input type="email" class="form-control" id="email" required>
					  	</p>
				    </div>
				    <div class="d-flex text-muted pb-1">   
						<p class=" small w-100">
							<strong class="d-block text-gray-dark">Senha</strong>          
							<input type="password" class="form-control" id="senha" maxlength="6">
						</p>
					</div>
				</div>
			</div> 
			<p class="col"></p>
		</div>
		<div class="row">
			<p class="col"></p>
	      	<div class="col-md-5 m-2 p-3 bg-body rounded shadow-sm" id="campos_parametros_verificar_existencia_usuario" class="form-group" style="display: none;">
		        <h6 class="border-bottom pb-2 mb-0">Reposicao da senha</h6>
				
			    <div class="d-flex text-muted pb-1">   
					<p class=" small w-100">
						<strong class="d-block text-gray-dark">Telefone</strong>          
						<input type="text" class="form-control" id="telefoneR" >
					</p>
				</div>
			    <div class="d-flex text-muted pb-1">   
					<p class=" small w-100">
						<strong class="d-block text-gray-dark">Pergunta</strong>          
						<span id="pergunta" class="form-control"></span>
					</p>
				</div>
			    <div class="d-flex text-muted pb-1">   
					<p class=" small w-100">
						<strong class="d-block text-gray-dark">Resposta</strong>       
						<input type="text" class="form-control" id="respostaR" > 
					</p>
				</div>
				<button class="btn border w-100" id="btn_para_redefinir_senha">Prosseguir</button>

			    <div class="text-muted pb-1" id="msg_para_redifinir" style="display:none;">   
					<p class=" small w-100">
						<p><strong class="d-block text-gray-dark">Acao para finalizar</strong> </p>      
						<p class="my-1 form-control">Visite o seu gmail, la recebeste o link para a reposicao da senha.</p>
					</p>
				</div>
		    </div>
			<p class="col"></p>
		</div>
	</main>
  	<footer class="footer fixed-bottom text-uppercase text-light text-center">
  		Todos os direitos reservados copyriht systuinfo . 2024
  	</footer>


 	<script type="module">

		//====================================
		//INICIALIZANDO A CONEXAO COM FIREBASE
		//====================================

		//Importacao do que precisamos trabalhar
		//--------------------------------------
		import {initializeApp} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
		import {getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, signOut} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
		import {getDatabase,get, ref,set,child} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

	    var firebaseConfig = {
	          apiKey: "AIzaSyDohCeHRGxRiO4sfN9pOFHVUqe01cuzUEg",
	          authDomain: "systuinfo.firebaseapp.com",
	          databaseURL: "https://systuinfo-default-rtdb.firebaseio.com",
	          projectId: "systuinfo",
	          storageBucket: "systuinfo.appspot.com",
	          messagingSenderId: "604412345972",
	          appId: "1:604412345972:web:96338d9c4f5853d1765b21"
	     };
	     

	     // Inicialize o Firebase
	    var app=initializeApp(firebaseConfig);



	    //Antes de mais nada, terminar sessao
	    //-----------------------------------
	    getAuth().signOut().then(function() {
			// Sign-out bem-sucedido.
		}).catch(function(error) {
		  // Ocorreu um erro durante o sign-out.
		  console.error("Erro ao desconectar o usuário:", error);
		});



        var email = document.getElementById('email');
        var senha = document.getElementById('senha');
        var msg_login = document.getElementById('msg_login');
        var campos_credencial = document.getElementById('campos_credencial');
        var tentativas_sig_in=0;

        //Reposicao da senha reerencia  necessaria
        var campos_parametros_verificar_existencia_usuario = document.getElementById('campos_parametros_verificar_existencia_usuario');

        var id = document.getElementById('idR');
        var primeiro_nome = document.getElementById('primeiro_nomeR');
        var ultimo_nome = document.getElementById('ultimo_nomeR');
        var telefone = document.getElementById('telefoneR');
        var pergunta = document.getElementById('perguntaR');
        var resposta = document.getElementById('respostaR');

        
     
		function fazerLogin(email, senha) {
			return signInWithEmailAndPassword(getAuth(app),email, senha).then(userCredential => {
				const user = userCredential.user;
        		msg_login.style.display="none";
        		tentativas_sig_in;
				localStorage.setItem('usuario', user.email);
				window.location.href = 'inicial.html';
			}).catch(error => {
        		msg_login.style.display="block";
				if(error.message.includes("invalid-email")){
        			msg_login.innerHTML="Email nao definido coretamente";
        			msg_login.style.color="red";

				}else if(error.message.includes("invalid-login-credentials")){
					tentativas_sig_in ++;
        			msg_login.innerHTML="Credecial nao correto<br>Tentativa falha "+tentativas_sig_in;
        			msg_login.style.color="red";
				}else if(error.message.includes("Access to this account has been temporarily disabled due to many failed login attempts")){
        			msg_login.innerHTML="O acesso a esta conta foi temporariamente desativado devido a muitas tentativas de login malsucedidas. Você pode restaurá-lo imediatamente redefinindo sua senha ou tentar novamente mais tarde";
        			msg_login.style.color="red";
        			campos_credencial.style.display="none";
        			campos_parametros_verificar_existencia_usuario.style.display="block";
        			document.querySelector('.login-container').style.width="500px";
				}
				throw error;
			});
		}

		function verificarParaRedefinicaoDaSenha(email,id,nome,apelido,tell,pergunta,resposta){

			// Construa a referência para o nó de usuários
			const usuariosRef = ref(getDatabase(app), 'systuinfo/usuario');

			// Execute a consulta para encontrar o usuário
			get(child(usuariosRef, id)).then((snapshot) => {
				if (snapshot.exists()) {
					// O usuário existe, verifique se os dados correspondem
					const usuario = snapshot.val();
					if (usuario.primeiro_nome.toLowerCase() === nome.toLowerCase() &&
						usuario.ultimo_nome.toLowerCase() === apelido.toLowerCase() && 
						usuario.telefone === tell &&
						usuario.pergunta.toLowerCase() === pergunta.toLowerCase() && 
						usuario.resposta.toLowerCase() === resposta.toLowerCase()) {
						console.log('Usuário encontrado:', snapshot.key);// torna o id do systuinfo/usuario
						document.getElementById('btn_para_redefinir_senha').style.display="block";
					} else {						
						msg_login.innerHTML="Verifique melhor todos campos menos "+id+".";
					}
				} else {					
					msg_login.innerHTML="O "+id+" nao existe.";
				}
			}).catch((error) => {
				console.error('Erro ao buscar usuário:', error);
				if(error.message.includes("path argument was an invalid path")){
				}
			});
		}
		
		function redefinicaoSenha(email){
			sendPasswordResetEmail(getAuth(app), email).then(() => {
				// Email de redefinição de senha enviado
				msg_login.innerHTML="Email de redefinição de senha enviado para: "+email+"<br><br>Abra o Gmail, e finalize o processo";
        		msg_login.style.color="green";
        		//campos_parametros_verificar_existencia_usuario.style.display="none";
				this.style.display="none";
				document.getElementById('msg_para_redifinir').style.display="block";
				return email;
			}).catch((error) => {
				const errorCode = error.code;
				const errorMessage = error.message;
				// Tratar erros, se houver
				console.error(errorMessage);
				throw error;
			});
		}
        senha.oninput=function() {
        	// body...

        	if(senha.value.length>5){
        		// Chame a função fazerLogin e atribua seu resultado a value_sig_in
				fazerLogin(email.value, senha.value);
        	}
        }
        document.getElementById('btn_para_redefinir_senha').onclick=function(){
			redefinicaoSenha(email.value);
        }

    </script>

    <script src="js/bootstrap.bundle.min.js"></script>

    <script src="js/offcanvas.js"></script>
    </body>
</html>