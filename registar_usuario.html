<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication Example</title>
    
    <!-- Adicione as bibliotecas do Firebase -->    f
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://ubissega.github.io/Systuinfo/estilo/css.css" rel="stylesheet" />
    <style type="text/css">
		.bg-main{    
		    background: url('https://i.imgur.com/sqq5Rb6.png') no-repeat fixed;
		    background-size: cover;
		}
    
    </style>
</head>
<body class="bg-main container">
	<nav class=" nav-body">
		<div class="d-flex justify-content-between b-b w-100">
			<h1 class="bg-t-h1 text-uppercase t-s">systuinfo</h1>
		   	<div class="dropdown">
		   		<button class="btn btn-secondary" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">Insrição do estudante</button>
				<ul class="dropdown-menu dropdown-menu-dark w-100" aria-labelledby="dropdownMenuButton2">
				<li><a class="dropdown-item" href="index.html">Pagina inicial</a></li>
				<li><a class="dropdown-item active" href="index.html">Iniciar sessao</a></li>
				<li><hr class="dropdown-divider"></li>
				<li><a class="dropdown-item" href="#">Manual de uso</a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="login-body">					
		<div class="insc-container">		
			<div class="form-group">
				<form action="#" class="row needs-validation" novalidate>
					<div class="col-md-6">						
			    		<input type="text" name="primeiro_nome" class="form-control" placeholder="Nome" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="text" name="nome_meio" class="form-control" placeholder="Nome do meio">
			    		<span class="valid-feedback">Nao obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="text" name="ultimo_nome" class="form-control" placeholder="Apelido" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="number" name="telefone" class="form-control" placeholder="Telefone" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="text" name="cidade" class="form-control" placeholder="Cidade" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="text" name="morada" class="form-control" placeholder="Morada (bairro)" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="file" name="id_pic_perfil" class="form-control">
			    		<span class="valid-feedback">Nao obrigatorio</span>
			    	</div>
					<div class="col-md-6">
						<select class="form-select" name="nivel" required>
							<option value="">Selecione nivel</option>
							<option >iniciante</option>
							<option >pos iniciante</option>
							<option >finalista</option>
							<option >experiente</option>
						</select>						
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-12">
		        		<img id="imagem-preview" src="" alt="Imagem de Perfil" style="max-width: 50%; display: none; margin-left: 25%;margin-right: 25%;">
		        	</div>
					<div class="col-md-6">						
			    		<input type="email" name="email" class="form-control" placeholder="Email" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="password" name="senha" class="form-control" placeholder="Senha" required >
			    		<span id="spansenha" class="invalid-feedback">Obrigatorio</span>
			    	</div>

					<div class="col-md-12">						
			    		<button id="submit" type="submit">Submeter</button>
			    	</div>
		    	</form>
			</div>
		</div>
	</div>
  	<footer class="footer text-uppercase">
  		Todos os direitos reservados copyriht systuinfo . 2024
  	</footer>


	<script type="module">

		//====================================
		//INICIALIZANDO A CONEXAO COM FIREBASE
		//====================================

		//Importacao do que precisamos trabalhar
		//--------------------------------------
		import {initializeApp} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
		import {getDatabase,get,ref,set,child} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
		import {getAuth, createUserWithEmailAndPassword} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
		import {getStorage,getDownloadURL, ref as storageRef, uploadBytes } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

	    const firebaseConfig = {
	          apiKey: "AIzaSyDohCeHRGxRiO4sfN9pOFHVUqe01cuzUEg",
	          authDomain: "systuinfo.firebaseapp.com",
	          databaseURL: "https://systuinfo-default-rtdb.firebaseio.com",
	          projectId: "systuinfo",
	          storageBucket: "systuinfo.appspot.com",
	          messagingSenderId: "604412345972",
	          appId: "1:604412345972:web:96338d9c4f5853d1765b21"
	     };
	     
	     // Inicialize o Firebase
	    var app=initializeApp(firebaseConfig);
		var db=getDatabase(app);
		var storage = getStorage(app);
		var auth = getAuth(app);


		//=============================
		//GERADOR E VERIFICA:|AO DO ID
		//=============================
	    var id_user_gerado = Math.floor(Math.random(1111111111) * 9999999999);
	    var id_img_gerado = Math.floor(Math.random(111111111111111) * 999999999999999);
	    var estadouser=isExistUserById(id_user_gerado);
	    var estadoimg=isExistImgById(id_img_gerado);
	    var i=0;
	    
		while(estadouser==1){
			estadouser=isExistUserById(id_user_gerado);
			i++;
			if(i==10000){
				break;
			}
		}

		while(estadoimg==1){
			estadoimg=isExistImgById(id_img_gerado);
			i++;
			if(i==10000){
				break;
			}
		}
		
	    //verificarExistenciaID(numeroAleatorio);

		//=============================
		//GLOBARIAR VARIAVEIS
		//=============================	
		var primeiro_nome="";
		var nome_meio="";
		var ultimo_nome="";
		var telefone="";
		var morada="";
		var cidade="";
		var inputImagem = document.querySelector('input[name="id_pic_perfil"]');
		var imagemPreview = document.getElementById('imagem-preview');	
		var arquivoImagem="";
		var nivel="";
		var email="";
		var senha="";




		inputImagem.onchange = function() {
			arquivoImagem = inputImagem.files[0];

	        // Atualize a imagem de preview com a URL do arquivo selecionado
	        const urlImagem = URL.createObjectURL(arquivoImagem);
	        imagemPreview.src = urlImagem;

	        // Exiba a imagem de preview
	        imagemPreview.style.display = 'block';
	    };

		function validacao2() {
	    
		    primeiro_nome = document.querySelector('input[name="primeiro_nome"]').value;
		    nome_meio = document.querySelector('input[name="nome_meio"]').value;
		    ultimo_nome = document.querySelector('input[name="ultimo_nome"]').value;  
		    // Verificar se um arquivo foi selecionado
		    if (!(inputImagem.files.length > 0)) {
				alert("Nenhum arquivo de imagem selecionado.");
		    }

		    telefone = document.querySelector('input[name="telefone"]').value;
		    morada = document.querySelector('input[name="morada"]').value;
		    cidade = document.querySelector('input[name="cidade"]').value;
		    nivel = document.querySelector('select[name="nivel"]').value;
		    email = document.querySelector('input[name="email"]').value;
		    senha = document.querySelector('input[name="senha"]').value;

			insAuth();
			
		}

	

		//===========================================================================================================
		//TRABALHANDO NA REALTIME DATABASE FIREBASE
		//============================================================================================================

		//===================================
		//VERIFICAR SE O ID DO USUARIO EXISTE
		//====================================
		function isExistUserById(idVerificar) {
			const caminhoNoUsuario = `systuinfo/usuario/${idVerificar}`;
			const referenciaNoUsuario = ref(db, caminhoNoUsuario);

			get(referenciaNoUsuario).then((snapshot) => {
			  if (snapshot.exists()) {
			    // O nó com a chave 236725342 existe
			    return 1;
			  } else {
			    // O nó com a chave 236725342 não existe
			    return 0;
			  }
			}).catch((error) => {
			  // Ocorreu um erro ao buscar o nó
			  //console.log("Erro ao verificar a existência do nó:", error);
			  return -1;
			});
		}
		
		function isExistImgById(idVerificar) {
			const caminhoNoUsuario = `systuinfo/imagem/${idVerificar}`;
			const referenciaNoUsuario = ref(db, caminhoNoUsuario);

			return get(referenciaNoUsuario).then((snapshot) => {
				if (snapshot.exists()) {
					// O nó com a chave idVerificar existe
					return 1; // Retorna 1 para indicar que a imagem existe
				} else {
					// O nó com a chave idVerificar não existe
					return 0; // Retorna 0 para indicar que a imagem não existe
				}
			}).catch((error) => {
				// Ocorreu um erro ao buscar o nó
				console.error("Erro ao verificar a existência da imagem:", error);
				return -1; // Retorna -1 para indicar um erro
			});
		}
		
		//==============================
		//INSERÇÃO NA BASE DE DADOS
		//==============================
		function insAuth(){
			createUserWithEmailAndPassword(auth, email, senha).then((userCredential) => {
				const usuario = userCredential.user;
				var uid = usuario.uid;

				// Caminho no Realtime Database onde você deseja armazenar os dados do usuário
				const dbPath = "systuinfo/usuario/" + id_user_gerado;

				// Referência ao nó no Realtime Database
				const dbRef = ref(db, dbPath);

				// Referência ao local no Firebase Storage onde você deseja armazenar a imagem
				const storagePath = "systuinfo/imagem/" + id_img_gerado;
				const imagemRef = storageRef(storage, storagePath);

				// Fazer upload da imagem para o Firebase Storage
				uploadBytes(imagemRef, arquivoImagem).then((snapshot) => {
					// Obter a URL de download da imagem
					return getDownloadURL(imagemRef);
				}).then((downloadURL) => {

					// Inserir os dados do usuário no Realtime Database, incluindo a URL de download da imagem
					const userData = {
						id_user_auth:uid,
						primeiro_nome: primeiro_nome,
						nome_meio: nome_meio,
						ultimo_nome: ultimo_nome,
						telefone: telefone,
						morada: morada,
						cidade: cidade,
						source_img: downloadURL, // Armazene a URL de download da imagem, não o blob
						nivel: nivel
					};

					return set(dbRef, userData);
				}).then(() => {
					alert("Sucesso: Dados do usuário inseridos com sucesso!");
				}).catch((error) => {
					console.error("Erro: Não foi possível inserir os dados do usuário.", error);
					alert("Erro: Não foi possível inserir os dados do usuário.");
				});
			}).catch((error) => {
				const erro=error.message;
				if (erro.indexOf("pelo menos 6 caracteres")) {
  					document.querySelector('input[name="senha"]').classList.add('is-invalid');
  					document.getElementById('spansenha').innerHTML="Mais que 5 digitos";
				}

			});
		}

		// Função para criar um usuário com e-mail e senha e associar dados adicionais



		// Example starter JavaScript for disabling form submissions if there are invalid fields
		(function () {
		  'use strict'

		  // Fetch all the forms we want to apply custom Bootstrap validation styles to
		  var forms = document.querySelectorAll('.needs-validation')

		  // Loop over them and prevent submission
		  Array.prototype.slice.call(forms)
		    .forEach(function (form) {
		      form.addEventListener('submit', function (event) {
		        event.preventDefault()
		        if (!form.checkValidity()) {
		          event.stopPropagation()
		        }else{
		        	validacao2();
		        }

		        form.classList.add('was-validated')
		      }, false)
		    })
		})()

		
	</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</body>
</html>
