<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication Example</title>
    
    <!-- Adicione as bibliotecas do Firebase -->    f
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://ubissega.github.io/Systuinfo/estilo/css.css" rel="stylesheet" />
    
    <!-- Use a versão 8 do Firebase SDK para evitar problemas com módulos ESM -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Adicione aqui as configurações do seu projeto Firebase -->
    <script defer src="js/firebase.js"></script>

    <style type="text/css">
		.bg-main{    
		    background: url('https://i.imgur.com/sqq5Rb6.png') no-repeat fixed;
		    background-size: cover;
		}
    </style>
</head>
<body class="bg-main login-body">					
		<div class="insc-container">	
	   		<h1><center>Criar usuário</center></h1>		
			<div class="form-group">
				<form action="#" class="row needs-validation" novalidate>
					<div class="col-md-6">						
			    		<input type="text" name="primeiro_nome" class="form-control" placeholder="Nome" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="text" name="nome_meio" class="form-control" placeholder="Nome do meio">
			    		<span class="valid-feedback">Nao obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="text" name="ultimo_nome" class="form-control" placeholder="Apelido" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
					</div>
					<div class="col-md-6">						
			    		<input type="number" name="telefone" class="form-control" placeholder="Telefone" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="text" name="cidade" class="form-control" placeholder="Cidade" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="text" name="morada" class="form-control" placeholder="Morada (bairro)" required>
			    		<span class="invalid-feedback">Obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
			    		<input type="file" name="id_pic_perfil" class="form-control" onchange="exibirImagem()">
			    		<span class="valid-feedback">Nao obrigatorio</span>
			    	</div>
					<div class="col-md-6">						
		        		<img id="imagem-preview" src="" alt="Imagem de Perfil" style="max-width: 100%; display: none;">
		        	</div>

					<div class="col-md-12">						
			    		<button type="submit">Submeter</button>
			    	</div>
		    	</form>
			</div>
		</div>
	</div>
  



	<script>

		//=============================
		//GERADOR E VERIFICA:|AO DO ID
		//=============================
	    var numeroAleatorio = Math.floor(Math.random(111111111111111) * 999999999999999);

		//=============================
		//GLOBARIAR VARIAVEIS
		//=============================	
		// Defina a função anônima que cria a referência da coleção
		
		var caminhoColecaoUsuario = "systuinfo";
		var referenciaBD="https://systuinfo-default-rtdb.firebaseio.com/systuinfo/usuario";
	    	//verificarExistenciaID(numeroAleatorio);

		var dados={};
		var primeiro_nome="";
		var nome_meio="";
		var ultimo_nome="";
		var telefone="";
		var morada="";
		var cidade="";
		var inputImagem = document.querySelector('input[name="id_pic_perfil"]');
		var imagemPreview = document.getElementById('imagem-preview');	
		var arquivoImagem="";

		function exibirImagem() {
			arquivoImagem = inputImagem.files[0];
	
			// Atualize a imagem de preview com a URL do arquivo selecionado
			const urlImagem = URL.createObjectURL(arquivoImagem);
			imagemPreview.src = urlImagem;
	
			// Exiba a imagem de preview
			imagemPreview.style.display = 'block';
			alert(arquivoImagem);
		    
		 }

		function validacao2() {
	    
		    primeiro_nome = document.querySelector('input[name="primeiro_nome"]').value;
		    nome_meio = document.querySelector('input[name="nome_meio"]').value;
		    ultimo_nome = document.querySelector('input[name="ultimo_nome"]').value;  
		    // Verificar se um arquivo foi selecionado
		    if (!(inputImagem.files.length > 0)) {
				alert("Nenhum arquivo de imagem selecionado.");
		    }

		    telefone = document.querySelector('input[name="telefone"]').value;
		    morada = document.querySelector('input[name="morada"]').value;
		    cidade = document.querySelector('input[name="cidade"]').value;

			dados.id = numeroAleatorio;
			dados.primeiro_nome = primeiro_nome;
			dados.nome_meio = nome_meio;
			dados.ultimo_nome = ultimo_nome;
			dados.id_pic_perfil = arquivoImagem;
			dados.telefone = telefone;
			dados.cidade = cidade;
			dados.morada = morada;

			insUsuario();
			
		}

		function insUsuario(){
			var bd= firebase.database();
		    	//alert(dados.id);
		    	alert(bd);   
			bd.ref('systuinfo/usuario').orderByChild('id').equalTo(numeroAleatorio).once('value').then(function(snapshot) {
			        if (snapshot.exists()) {
			            console.log("TRUE");// true;
			        } else {
			            console.log("FALSE");//return false;
			        }
			    }).catch(function(erro) {
			        console.log("Erro ao verificar a existência do ID:", erro);
			});

			
			// Caminho para a coleção (ou nó) onde você deseja armazenar os dados
			var caminhoColecao = "usuarios";

			// Referência ao nó onde você deseja armazenar os dados
			var referenciaNodo = database.ref(caminhoColecao);

			// Insere os dados no banco de dados
			referenciaNodo.push(dados)
			  .then(function() {
			    console.log("Dados inseridos com sucesso!");
			  })
			  .catch(function(erro) {
			    console.error("Erro ao inserir dados:", erro);
			  });

		}
	
	

		//===========================================================================================================
		//TRABALHANDO NA REALTIME DATABASE FIREBASE
		//============================================================================================================
		
/*
		//===================================
		// VERIFICAR SE O ID DO USUÁRIO EXISTE
		//====================================
		function verificarExistenciaID(idVerificar) {
		    referenciaBD.orderByChild("id").equalTo(idVerificar).once('value').then(function(snapshot) {
		        if (snapshot.exists()) {
		            alert("TRUE");// true;
		        } else {
		            alert("FALSE");//return false;
		        }
		    }).catch(function(erro) {
		        alert("Erro ao verificar a existência do ID:", erro);
		    });
		}	

		//==============================
		//INSERÇÃO DA IMAGEM NA BASE DE DADOS
		//==============================
		function insUsuario() {
			// body...
			// Dados a serem inseridos
			

			// Caminho para a coleção (ou nó) onde você deseja armazenar os dados
			var caminhoColecao = "usuarios";

			// Referência ao nó onde você deseja armazenar os dados
			var referenciaNodo = database.ref(caminhoColecao);

			// Insere os dados no banco de dados
			referenciaNodo.push(dados)
			  .then(function() {
			    console.log("Dados inseridos com sucesso!");
			  })
			  .catch(function(erro) {
			    console.error("Erro ao inserir dados:", erro);
			  });

		}
*/

		// Example starter JavaScript for disabling form submissions if there are invalid fields
		(function () {
		  'use strict'
			
		  // Fetch all the forms we want to apply custom Bootstrap validation styles to
		  var forms = document.querySelectorAll('.needs-validation')

		  // Loop over them and prevent submission
		  Array.prototype.slice.call(forms)
		    .forEach(function (form) {
		      form.addEventListener('submit', function (event) {
		        if (!form.checkValidity()) {
		          event.preventDefault()
		          event.stopPropagation()
		        }else{
		        	validacao2();
		        }

		        form.classList.add('was-validated')
		      }, false)
		    })
		})()

		
	</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
